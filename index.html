<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能生科论文检索系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url('http://121.41.123.104/static/image/photo.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #555;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #444;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .form-group label i {
            margin-right: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 16px;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px 12px 12px 45px;
            font-size: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: rgba(248, 249, 250, 0.9);
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            outline: none;
        }

        .year-group {
            display: flex;
            gap: 15px;
        }

        .year-group .form-group {
            flex: 1;
        }

        .year-group select {
            padding-left: 45px;
        }

        .button-group {
            text-align: center;
            margin-top: 25px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            margin: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-size: 16px;
            margin: 20px 0;
        }

        .papers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: block;
            overflow-x: auto;
        }

        .papers-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .papers-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            white-space: normal;
        }

        .papers-table tr:last-child td {
            border-bottom: none;
        }

        .papers-table tr:hover {
            background-color: #f8f9fa;
        }

        .paper-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .paper-journal {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .paper-date {
            color: #888;
            font-size: 13px;
        }

        .paper-if {
            color: #27ae60;
            font-size: 14px;
            font-weight: bold;
        }

        .paper-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 15px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .detail-btn {
            background: #3498db;
            color: white;
        }

        .summary-btn {
            background: #9b59b6;
            color: white;
        }

        .image-btn {
            background: #2ecc71;
            color: white;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.95);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .summary-content {
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 15px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .image-container-wrapper {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 0;
            border: 1px solid #eee;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            margin-top: 20px;
        }

        .image-container-wrapper::-webkit-scrollbar {
            width: 12px;
        }

        .image-container-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .image-container-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .image-container-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            padding: 10px;
        }

        .image-item {
            flex: 1;
            min-width: 300px;
            text-align: center;
        }

        .image-item img {
            max-width: 100%;
            max-height: 500px;
            width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 3px solid #e1e5e9;
            background-color: #f0f0f0;
            transition: transform 0.2s ease-in-out;
        }

        .image-item img:hover {
            transform: scale(1.02);
        }

        .image-title {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #333;
        }

        .image-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .image-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .image-link:hover {
            text-decoration: underline;
        }

        .modal-loading {
            font-size: 18px;
            color: #667eea;
            margin: 30px 0;
        }

        .modal-error {
            color: #e74c3c;
            font-size: 18px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .year-group {
                flex-direction: column;
                gap: 15px;
            }

            .container {
                padding: 20px;
                margin: 10px;
            }

            body {
                padding: 10px;
            }

            .papers-table {
                font-size: 14px;
            }

            .papers-table th, .papers-table td {
                padding: 8px 10px;
            }

            .paper-actions {
                flex-direction: column;
                gap: 5px;
            }

            .action-btn {
                width: 100%;
            }

            .image-item {
                min-width: 100%;
            }

            .image-container-wrapper {
                max-height: 60vh;
            }

            .image-item img {
                max-height: 400px;
                min-height: 200px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-search"></i> 智能生科论文检索系统</h1>
            <p>输入关键词和时间范围，快速获取相关学术论文</p>
        </div>

        <form id="searchForm">
            <div class="form-group">
                <label for="key1"><i class="fas fa-key"></i> 主要关键词</label>
                <div class="input-wrapper">
                    <i class="fas fa-key"></i>
                    <input type="text" id="key1" name="key1" placeholder="例如：机器学习、人工智能...">
                </div>
            </div>

            <div class="form-group">
                <label for="key2"><i class="fas fa-tags"></i> 发表期刊</label>
                <div class="input-wrapper">
                    <i class="fas fa-tags"></i>
                    <input type="text" id="key2" name="key2" placeholder="例如：Nature、Science...">
                </div>
            </div>

            <div class="form-group">
                <label for="theme"><i class="fas fa-book"></i> 研究主题</label>
                <div class="input-wrapper">
                    <i class="fas fa-book"></i>
                    <input type="text" id="theme" name="theme" placeholder="例如：基因组学、肺癌...">
                </div>
            </div>

            <div class="year-group">
                <div class="form-group">
                    <label for="start_year"><i class="fas fa-calendar-alt"></i> 起始年份</label>
                    <div class="input-wrapper">
                        <i class="fas fa-calendar-alt"></i>
                        <select id="start_year" name="start_year">
                            <option value="">请选择起始年份</option>
                            <option value="2018">2018</option>
                            <option value="2019">2019</option>
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="end_year"><i class="fas fa-calendar-check"></i> 结束年份</label>
                    <div class="input-wrapper">
                        <i class="fas fa-calendar-check"></i>
                        <select id="end_year" name="end_year">
                            <option value="">请选择结束年份</option>
                            <option value="2018">2018</option>
                            <option value="2019">2019</option>
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="submit">
                    <i class="fas fa-bolt"></i> 开始检索
                </button>
            </div>

            <div class="loading" id="loading">
                <i class="fas fa-spinner fa-spin"></i> 正在检索中...
            </div>
        </form>

        <div id="papersTableContainer" style="display: none; margin-top: 30px;">
            <h3 style="color: #333; margin-bottom: 15px; text-align: center;">
                <i class="fas fa-list"></i> 检索结果 (按影响因子排序)
            </h3>
            <div id="papersTable"></div>
        </div>

        <div class="footer">
            <p>© 2025 智能生科论文检索系统 | 基于AI技术的学术搜索引擎</p>
        </div>
    </div>

    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSummaryModal()">&times;</span>
            <h2 class="modal-title"><i class="fas fa-file-alt"></i> 论文总结</h2>
            <div id="summaryModalContent">
                <div class="modal-loading" id="summaryLoading">
                    <i class="fas fa-spinner fa-spin"></i> 正在生成总结，请稍候...
                </div>
                <div class="modal-error" id="summaryError" style="display: none;"></div>
                <div class="summary-content" id="summaryContent" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeImageModal()">&times;</span>
            <h2 class="modal-title"><i class="fas fa-images"></i> 论文相关图片</h2>
            <div id="imageModalContent">
                <div class="modal-loading" id="imageLoading">
                    <i class="fas fa-spinner fa-spin"></i> 正在生成图片，请稍候...
                </div>
                <div class="modal-error" id="imageError" style="display: none;"></div>
                <div class="image-container-wrapper" id="imageContainerWrapper" style="display: none;">
                    <div class="image-container" id="imageContainer">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 保存当前搜索结果
        let currentSearchResults = [];

        // 缓存对象 - 保存总结和图片结果
        let summaryCache = {}; // {paperId: {summary: string, timestamp: number}}
        let imageCache = {};   // {paperId: {result: string, timestamp: number}}

        // 缓存过期时间（10分钟）
        const CACHE_EXPIRY = 10 * 60 * 1000; // 10分钟 = 600000毫秒

        // 清理过期缓存的函数
        function cleanupExpiredCache() {
            const now = Date.now();

            // 清理过期的总结缓存
            for (let paperId in summaryCache) {
                if (now - summaryCache[paperId].timestamp > CACHE_EXPIRY) {
                    delete summaryCache[paperId];
                }
            }

            // 清理过期的图片缓存
            for (let paperId in imageCache) {
                if (now - imageCache[paperId].timestamp > CACHE_EXPIRY) {
                    delete imageCache[paperId];
                }
            }
        }

        // 提取URL的函数
        function extractUrl(text) {
            if (!text) return null;
            const urlMatch = text.match(/.*?:\s*(.+)$/);
            return urlMatch ? urlMatch[1].trim() : null;
        }

        // 显示论文表格
        function displayPapers(papers) {
            currentSearchResults = papers;
            cleanupExpiredCache(); // 清理过期缓存

            const container = document.getElementById('papersTableContainer');
            const tableDiv = document.getElementById('papersTable');

            let tableHTML = `
                <table class="papers-table">
                    <thead>
                        <tr>
                            <th width="5%">编号</th>
                            <th width="35%">论文信息</th>
                            <th width="15%">期刊</th>
                            <th width="10%">日期</th>
                            <th width="10%">IF</th>
                            <th width="25%">操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            papers.forEach(paper => {
                const ifDisplay = paper.impact_factor && paper.impact_factor !== 'N/A' ? paper.impact_factor : 'N/A';

                tableHTML += `
                    <tr>
                        <td>${paper.id + 1}</td>
                        <td>
                            <div class="paper-title">${paper.title}</div>
                        </td>
                        <td>
                            <div class="paper-journal">${paper.journal}</div>
                        </td>
                        <td>
                            <div class="paper-date">${paper.pub_date}</div>
                        </td>
                        <td>
                            <div class="paper-if">${ifDisplay}</div>
                        </td>
                        <td>
                            <div class="paper-actions">
                                <button class="action-btn detail-btn" onclick="openPaperUrl('${paper.url}')">
                                    <i class="fas fa-external-link-alt"></i> 详情
                                </button>
                                <button class="action-btn summary-btn" onclick="showPaperSummary(${paper.id})">
                                    <i class="fas fa-file-alt"></i> 总结
                                </button>
                                <button class="action-btn image-btn" onclick="showPaperImages(${paper.id})">
                                    <i class="fas fa-image"></i> 图片
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableDiv.innerHTML = tableHTML;
            container.style.display = 'block';
        }

        // 打开论文详情页面
        function openPaperUrl(url) {
            if (url && url !== '#') {
                window.open(url, '_blank');
            }
        }

        // 显示论文总结弹窗
        function showPaperSummary(paperId) {
            const paper = currentSearchResults.find(p => p.id === paperId);
            if (!paper) {
                alert('论文数据不存在');
                return;
            }

            const modal = document.getElementById('summaryModal');
            const loading = document.getElementById('summaryLoading');
            const error = document.getElementById('summaryError');
            const content = document.getElementById('summaryContent');

            // 检查缓存
            if (summaryCache[paperId] && (Date.now() - summaryCache[paperId].timestamp < CACHE_EXPIRY)) {
                // 使用缓存
                loading.style.display = 'none';
                content.textContent = summaryCache[paperId].summary;
                content.style.display = 'block';
                modal.style.display = 'block';
                return;
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';
            modal.style.display = 'block';

            // 发送完整的论文信息给后端
            fetch('/api/get_paper_summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    paper_id: paperId,
                    paper_data: {
                        title: paper.title,
                        url: paper.url,
                        abstract: paper.abstract || '',
                        journal: paper.journal,
                        pub_date: paper.pub_date,
                        impact_factor: paper.impact_factor
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                if (data.status === 'completed') {
                    content.textContent = data.summary;
                    content.style.display = 'block';

                    // 缓存结果
                    summaryCache[paperId] = {
                        summary: data.summary,
                        timestamp: Date.now()
                    };
                } else {
                    error.textContent = data.error || '获取总结失败';
                    error.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('获取论文总结错误:', error);
                loading.style.display = 'none';
                error.textContent = '网络错误：' + error.message;
                error.style.display = 'block';
            });
        }

        // 关闭总结弹窗
        function closeSummaryModal() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        // 显示论文图片弹窗
        function showPaperImages(paperId) {
            const paper = currentSearchResults.find(p => p.id === paperId);
            if (!paper) {
                alert('论文数据不存在');
                return;
            }

            const modal = document.getElementById('imageModal');
            const loading = document.getElementById('imageLoading');
            const error = document.getElementById('imageError');
            const containerWrapper = document.getElementById('imageContainerWrapper');
            const container = document.getElementById('imageContainer');

            // 检查缓存
            if (imageCache[paperId] && (Date.now() - imageCache[paperId].timestamp < CACHE_EXPIRY)) {
                // 使用缓存
                loading.style.display = 'none';
                const lines = (imageCache[paperId].result || '').split('\n\n');
                let screenshotUrl = null;
                let aiImageUrl = null;

                lines.forEach(line => {
                    if (line.includes('主页截图链接:')) {
                        screenshotUrl = extractUrl(line);
                    } else if (line.includes('AI插图链接:')) {
                        aiImageUrl = extractUrl(line);
                    }
                });

                displayImagesInModal(screenshotUrl, aiImageUrl);
                containerWrapper.style.display = 'block';
                modal.style.display = 'block';
                return;
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            containerWrapper.style.display = 'none';
            modal.style.display = 'block';

            // 发送完整的论文信息给后端
            fetch('/api/generate_images', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    paper_id: paperId,
                    paper_data: {
                        title: paper.title,
                        url: paper.url,
                        abstract: paper.abstract || '',
                        journal: paper.journal
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                if (data.status === 'completed') {
                    const lines = (data.result || '').split('\n\n');
                    let screenshotUrl = null;
                    let aiImageUrl = null;

                    lines.forEach(line => {
                        if (line.includes('主页截图链接:')) {
                            screenshotUrl = extractUrl(line);
                        } else if (line.includes('AI插图链接:')) {
                            aiImageUrl = extractUrl(line);
                        }
                    });

                    displayImagesInModal(screenshotUrl, aiImageUrl);
                    containerWrapper.style.display = 'block';

                    // 缓存结果
                    imageCache[paperId] = {
                        result: data.result,
                        timestamp: Date.now()
                    };
                } else {
                    error.textContent = data.error || '图片生成失败';
                    error.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('生成图片错误:', error);
                loading.style.display = 'none';
                error.textContent = '错误：' + error.message;
                error.style.display = 'block';
            });
        }

        // 在弹窗中显示图片
        function displayImagesInModal(screenshotUrl, aiImageUrl) {
            const imageContainer = document.getElementById('imageContainer');
            imageContainer.innerHTML = '';

            let hasImages = false;

            if (screenshotUrl && screenshotUrl !== '暂无' && screenshotUrl.trim() !== '' && !screenshotUrl.includes('暂无')) {
                const screenshotDiv = document.createElement('div');
                screenshotDiv.className = 'image-item';
                screenshotDiv.innerHTML = `
                    <div class="image-title">📸 主页截图</div>
                    <div class="image-description">论文主页的截图</div>
                    <img src="${screenshotUrl}" alt="主页截图" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4=';">
                    <br><a href="${screenshotUrl}" target="_blank" class="image-link">查看原图</a>
                `;
                imageContainer.appendChild(screenshotDiv);
                hasImages = true;
            }

            if (aiImageUrl && aiImageUrl !== '暂无' && aiImageUrl.trim() !== '' && !aiImageUrl.includes('暂无')) {
                const aiImageDiv = document.createElement('div');
                aiImageDiv.className = 'image-item';
                aiImageDiv.innerHTML = `
                    <div class="image-title">🎨 AI插图</div>
                    <div class="image-description">AI生成的论文内容插图</div>
                    <img src="${aiImageUrl}" alt="AI插图" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4=';">
                    <br><a href="${aiImageUrl}" target="_blank" class="image-link">查看原图</a>
                `;
                imageContainer.appendChild(aiImageDiv);
                hasImages = true;
            }

            if (!hasImages) {
                imageContainer.innerHTML = '<div style="width:100%; text-align:center; color:#666; padding:30px;">暂无图片可显示</div>';
            }
        }

        // 关闭图片弹窗
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // 点击弹窗外部关闭
        window.onclick = function(event) {
            const summaryModal = document.getElementById('summaryModal');
            const imageModal = document.getElementById('imageModal');

            if (event.target == summaryModal) {
                summaryModal.style.display = 'none';
            }
            if (event.target == imageModal) {
                imageModal.style.display = 'none';
            }
        }

        // 表单提交事件
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();

            document.getElementById('loading').style.display = 'block';
            document.getElementById('papersTableContainer').style.display = 'none';

            const formData = new FormData(this);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                 if (!response.ok) {
                     return response.json().then(errData => {
                         throw new Error(errData.result || `HTTP ${response.status}`);
                     });
                 }
                 return response.json();
             })
            .then(data => {
                document.getElementById('loading').style.display = 'none';

                if (data.status === 'success') {
                    displayPapers(data.papers);
                } else {
                    alert('检索出错：' + data.result);
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                alert('检索出错：' + error.message);
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>